<!doctype html>
<html lang="en-US">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<title>NASA FITS Explorer</title>
		<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%230f172a'/%3E%3Cpath fill='%23facc15' d='M16 4l3.4 7 7.6.7-5.8 5.2 1.8 7.6-7-4.2-7 4.2 1.8-7.6-5.8-5.2 7.6-.7z'/%3E%3C/svg%3E" />
		<link rel="stylesheet" href="/static/styles.css" />
		<link rel="stylesheet" href="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.min.css" />
	</head>
	<body>
		<div id="aladin-lite-div" aria-label="Interactive FITS viewer"></div>
		<aside class="hud" aria-live="polite">
			<p class="title">NASA FITS Explorer</p>
			<p class="status" id="status-message">Select a FITS source to start exploring.</p>
			<div class="controls">
				<label class="file-picker">
					<input id="fits-file" type="file" accept=".fits,.fit,application/fits" />
					<span>Open local FITS file</span>
				</label>
				<div class="url-loader">
					<input id="fits-url" type="url" placeholder="https://data.nasa.gov/sample.fits" aria-label="FITS file URL" />
					<button type="button" id="load-url">Load URL</button>
				</div>
			</div>
			<div class="samples">
				<span class="samples-label">Try a sample dataset:</span>
				<div class="sample-buttons">
					<button
						type="button"
						data-fits-url="https://cdsarc.cds.unistra.fr/saadavizier/download?oid=864972989978905533"
						data-label="WISE Infrared — IC 434 & Horsehead Nebula"
						data-colormap="magma"
					>
						Horsehead Nebula (WISE)
					</button>
					<button
						type="button"
						data-fits-url="https://fits.gsfc.nasa.gov/samples/NGC6543.fits"
						data-label="HST WFPC2 — NGC 6543 (Cat's Eye)"
						data-colormap="viridis"
					>
						Cat's Eye Nebula (HST)
					</button>
					<button
						type="button"
						data-fits-url="https://fits.gsfc.nasa.gov/samples/FUV.fits"
						data-label="GALEX FUV — M101 Spiral"
						data-colormap="plasma"
					>
						Pinwheel Galaxy (GALEX)
					</button>
				</div>
			</div>
			<p class="notice" id="aladin-hint">
				Upload high-resolution FITS files from NASA missions or paste a link to remote data sets. Large imagery may take a moment to render.
			</p>
			<p class="notice hidden" id="aladin-error" role="alert"></p>
		</aside>
		<script type="module">
			import { A } from 'https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.min.js';

			const statusMessage = document.getElementById('status-message');
			const errorBox = document.getElementById('aladin-error');
			const fileInput = document.getElementById('fits-file');
			const urlInput = document.getElementById('fits-url');
			const loadUrlButton = document.getElementById('load-url');
			const sampleButtons = Array.from(document.querySelectorAll('[data-fits-url]'));

			let aladinInstance = null;
			let currentRequestId = 0;

			const DEFAULT_SAMPLE = sampleButtons.length
				? {
						url: sampleButtons[0].dataset.fitsUrl,
						label: sampleButtons[0].dataset.label,
						colormap: sampleButtons[0].dataset.colormap
				  }
				: null;

			function showError(message) {
				errorBox.textContent = message;
				errorBox.classList.remove('hidden');
			}

			function clearError() {
				errorBox.textContent = '';
				errorBox.classList.add('hidden');
			}

			function updateStatus(label, fov) {
				const parts = [];
				if (label) {
					parts.push(`Source: ${label}`);
				}
				if (Number.isFinite(fov)) {
					const span = Math.max(0.01, fov * 2);
					parts.push(`FoV ≈ ${span.toFixed(2)}°`);
				}
				statusMessage.textContent = parts.join(' · ') || 'Ready to load a FITS image.';
			}

			function focusOnImage(ra, dec, fov) {
				if (Number.isFinite(ra) && Number.isFinite(dec)) {
					aladinInstance.gotoRaDec(ra, dec);
				}
				if (Number.isFinite(fov)) {
					const clamped = Math.min(60, Math.max(0.01, fov * 2));
					aladinInstance.setFoV(clamped);
				}
			}

			function configureImage(image, colormap) {
				if (!image) {
					return;
				}
				try {
					image.setColormap(colormap || 'magma', { stretch: 'sqrt' });
				} catch (error) {
					console.warn('Unable to update the FITS colormap', error);
				}
			}

			function deriveLabel(source) {
				if (typeof source === 'string') {
					try {
						const url = new URL(source);
						return url.hostname;
					} catch {
						return source;
					}
				}
				if (source && typeof source.name === 'string') {
					return `Local file: ${source.name}`;
				}
				return 'Custom FITS';
			}

			function loadFits(source, options = {}) {
				if (!aladinInstance || !source) {
					return;
				}

				const requestId = ++currentRequestId;
				const label = options.label || deriveLabel(source);

				clearError();
				const loadTimeout = window.setTimeout(() => {
					if (requestId !== currentRequestId) {
						return;
					}
					console.warn(`FITS load timed out: ${label}`);
					showError('The FITS file is taking longer than expected to respond. Please try again or use a different source.');
				}, options.timeout ?? 20000);

				const clearLoadState = () => {
					window.clearTimeout(loadTimeout);
				};

				const handleSuccess = (ra, dec, fov, image) => {
					if (requestId !== currentRequestId) {
						return;
					}
					clearLoadState();
					configureImage(image, options.colormap);
					focusOnImage(ra, dec, fov);
					updateStatus(label, fov);
				};

				const handleError = (error) => {
					if (requestId !== currentRequestId) {
						return;
					}
					clearLoadState();
					console.error('Failed to load FITS data', error);
					showError('Unable to load the FITS data. Please verify the file or URL and try again.');
				};

				try {
					const result = aladinInstance.displayFITS(source, options.params || {}, handleSuccess, handleError);
					if (result && typeof result.then === 'function') {
						result.catch(handleError).finally(clearLoadState);
					}
				} catch (error) {
					handleError(error);
				}
			}

			function handleFileSelection(event) {
				const [file] = event.target.files || [];
				if (!file) {
					return;
				}
				loadFits(file, { label: `Local file: ${file.name}` });
				event.target.value = '';
			}

			function handleUrlLoad() {
				const url = urlInput.value.trim();
				if (!url) {
					showError('Please enter a FITS file URL.');
					return;
				}
				try {
					new URL(url);
				} catch {
					showError('The URL appears to be invalid. Please double-check and try again.');
					return;
				}
				loadFits(url, { label: url });
			}

			function initialiseSampleButtons() {
				sampleButtons.forEach((button) => {
					button.addEventListener('click', () => {
						const { fitsUrl, label, colormap } = button.dataset;
						loadFits(fitsUrl, { label, colormap });
					});
				});
			}

			async function initialiseViewer() {
				try {
					await A.init;
					aladinInstance = await A.aladin('#aladin-lite-div', {
						cooFrame: 'icrs',
						projection: 'AIT',
						showCooGrid: false,
						fullScreen: true,
						fov: 5,
						target: 'M 31'
					});

					initialiseSampleButtons();
					if (DEFAULT_SAMPLE) {
						loadFits(DEFAULT_SAMPLE.url, DEFAULT_SAMPLE);
					} else {
						updateStatus(null);
					}
				} catch (error) {
					console.error('Aladin Lite failed to initialise', error);
					showError('The Aladin Lite viewer could not be initialised. Please refresh the page.');
				}
			}

			fileInput.addEventListener('change', handleFileSelection);
			fileInput.addEventListener('click', () => {
				clearError();
			});

			loadUrlButton.addEventListener('click', handleUrlLoad);
			urlInput.addEventListener('keydown', (event) => {
				if (event.key === 'Enter') {
					event.preventDefault();
					handleUrlLoad();
				}
			});

			initialiseViewer();
		</script>
	</body>
</html>
